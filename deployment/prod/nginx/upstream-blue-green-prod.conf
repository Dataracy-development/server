# api.dataracy.co.kr : HTTPS 강제 + HSTS

upstream backend_prod { server backend-prod-blue:8080; }  # 초기값 blue

# 안전망: 80→443 로컬 리다이렉트 (Cloudflare Redirect Rule과 중복되어도 OK)
server {
  listen 80;
  server_name api.dataracy.co.kr;
  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl http2;
  server_name api.dataracy.co.kr;

  ssl_certificate     /etc/nginx/ssl/cloudflare/origin.crt;
  ssl_certificate_key /etc/nginx/ssl/cloudflare/origin.key;
  ssl_protocols TLSv1.2 TLSv1.3; ssl_prefer_server_ciphers on;

  # HSTS (subdomains 포함 금지!)
  add_header Strict-Transport-Security "max-age=31536000" always;

  client_max_body_size 50m; client_body_timeout 120s;

  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";

  location /api {
    proxy_pass http://backend_prod;
    proxy_request_buffering off;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
  }

  location /actuator/health { proxy_pass http://backend_prod/actuator/health; }
  location / { proxy_pass http://backend_prod; }
}
