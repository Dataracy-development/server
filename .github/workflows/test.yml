name: Test and Code Quality

on:
  pull_request:
    branches: [develop, main]
  push:
    branches: [develop, main]

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: 📦 Checkout Source
        uses: actions/checkout@v4

      - name: ☕ Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: 🔐 Grant execute permission for Gradle
        run: chmod +x gradlew

      - name: 📋 Code Style Check
        run: |
          ./gradlew clean
          ./gradlew checkstyleMain checkstyleTest

      - name: 🧪 Run Tests (Unit Tests Only)
        run: |
          ./gradlew test --continue -Dtest.exclude.tags=integration
        continue-on-error: true

      - name: 📊 Test Results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Test Results
          path: "build/test-results/test/*.xml"
          reporter: java-junit
          fail-on-error: false

      - name: 📈 Test Coverage (if available)
        run: |
          if ./gradlew tasks --all | grep -q "jacocoTestReport"; then
            ./gradlew jacocoTestReport
          else
            echo "JaCoCo not configured, skipping coverage report"
          fi
        continue-on-error: true

      - name: 🏗️ Build Application
        run: ./gradlew build -x test

      - name: 📤 Upload Test Results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results
          path: |
            build/test-results/
            build/reports/tests/
          retention-days: 7
